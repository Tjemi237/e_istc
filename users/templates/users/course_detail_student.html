{% extends "base.html" %}

{% block title %}Cours: {{ course.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light p-3 rounded">
            <li class="breadcrumb-item"><a href="{% url 'users:etudiant_dashboard' %}">Mon Tableau de Bord</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ course.title }}</li>
        </ol>
    </nav>

    <!-- Course Header -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-auto">
                    {% if course.image %}
                        <img src="{{ course.image.url }}" alt="Image du cours" class="rounded-circle me-3" style="width: 100px; height: 100px; object-fit: cover;">
                    {% endif %}
                </div>
                <div class="col">
                    <h2 class="card-title mb-1">{{ course.title }}</h2>
                    <p class="card-text text-muted">{{ course.description }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Tabs Navigation -->
            <ul class="nav nav-pills nav-fill mb-4" id="courseTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="modules-tab" data-bs-toggle="tab" data-bs-target="#modules" type="button" role="tab" aria-controls="modules" aria-selected="true"><i class="bi bi-book me-2"></i>Modules</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="annonces-tab" data-bs-toggle="tab" data-bs-target="#annonces" type="button" role="tab" aria-controls="annonces" aria-selected="false"><i class="bi bi-megaphone me-2"></i>Annonces</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="evaluations-tab" data-bs-toggle="tab" data-bs-target="#evaluations" type="button" role="tab" aria-controls="evaluations" aria-selected="false"><i class="bi bi-journal-check me-2"></i>Évaluations</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="forum-tab" data-bs-toggle="tab" data-bs-target="#forum" type="button" role="tab" aria-controls="forum" aria-selected="false"><i class="bi bi-chat-left-text me-2"></i>Forum</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="courseTabsContent">
                <!-- Modules Tab Content -->
                <div class="tab-pane fade show active" id="modules" role="tabpanel" aria-labelledby="modules-tab">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0">Contenu du Cours</h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion accordion-flush" id="modulesAccordion">
                                {% for module in course.modules.all %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="module-heading-{{ module.id }}">
                                        <button class="accordion-button {% if forloop.first %} {% else %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#module-collapse-{{ module.id }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="module-collapse-{{ module.id }}">
                                            {{ module.title }}
                                        </button>
                                    </h2>
                                    <div id="module-collapse-{{ module.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="module-heading-{{ module.id }}" data-bs-parent="#modulesAccordion">
                                        <div class="accordion-body">
                                            <p>{{ module.description }}</p>
                                            <ul class="list-group list-group-flush">
                                                {% for ressource in module.ressources.all %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <input type="checkbox" class="form-check-input me-2" data-ressource-id="{{ ressource.id }}" {% if ressource.id in completed_ressources_ids %}checked{% endif %}>
                                                        {{ ressource.title }}
                                                    </div>
                                                    <div>
                                                        {% if ressource.file %}
                                                            <a href="{{ ressource.file.url }}" target="_blank" class="btn btn-sm btn-outline-info" aria-label="Voir Fichier"><i class="bi bi-file-earmark"></i></a>
                                                        {% endif %}
                                                        {% if ressource.url %}
                                                            <a href="{{ ressource.url }}" target="_blank" class="btn btn-sm btn-outline-info" aria-label="Voir URL"><i class="bi bi-link-45deg"></i></a>
                                                        {% endif %}
                                                    </div>
                                                </li>
                                                {% empty %}
                                                <li class="list-group-item text-muted">Aucune ressource pour ce module.</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">Aucun module pour ce cours pour le moment.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Announcements Tab Content -->
                <div class="tab-pane fade" id="annonces" role="tabpanel" aria-labelledby="annonces-tab">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0">Annonces</h5>
                        </div>
                        <div class="card-body">
                            {% for annonce in annonces %}
                                <div class="alert alert-info alert-dismissible fade show" role="alert">
                                    <h6 class="alert-heading">{{ annonce.titre }}</h6>
                                    <p class="mb-0">{{ annonce.contenu|linebreaksbr }}</p>
                                    <hr>
                                    <small class="text-muted">Publié le: {{ annonce.cree_le|date:"d/m/Y H:i" }}</small>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% empty %}
                                <p class="text-muted">Aucune annonce.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Evaluations Tab Content -->
                <div class="tab-pane fade" id="evaluations" role="tabpanel" aria-labelledby="evaluations-tab">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0">Évaluations</h5>
                        </div>
                        <div class="card-body">
                            <!-- Devoirs Section -->
                            <h6 class="mb-3 text-primary"><i class="bi bi-file-earmark-text me-2"></i>Devoirs</h6>
                            <div class="list-group mb-4">
                                {% for activite in activites %}
                                    {% if activite.activity_type == 'DEVOIR' %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="mb-1">{{ activite.title }}</h5>
                                                <small class="text-muted">Date limite : {{ activite.due_date|date:"d/m/Y H:i" }}</small>
                                                <p class="mb-1">{{ activite.description }}</p>
                                            </div>
                                            <div class="text-end">
                                                {% if activite.id in submitted_activities_ids %}
                                                    <button class="btn btn-secondary btn-sm" disabled><i class="bi bi-check-circle me-1"></i>Déjà soumis</button>
                                                {% else %}
                                                    <a href="{% url 'users:submit_assignment' activite.id %}" class="btn btn-primary btn-sm" aria-label="Soumettre le devoir"><i class="bi bi-upload me-1"></i> Soumettre</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                {% empty %}
                                    <p class="p-3 text-muted">Aucun devoir disponible.</p>
                                {% endfor %}
                            </div>

                            <!-- Quiz Section -->
                            <h6 class="mb-3 text-primary"><i class="bi bi-patch-question me-2"></i>Quiz</h6>
                            <div class="list-group mb-4">
                                {% for activite in activites %}
                                    {% if activite.activity_type == 'QUIZ' %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="mb-1">{{ activite.title }}</h5>
                                                <small class="text-muted">Date limite : {{ activite.due_date|date:"d/m/Y H:i" }}</small>
                                                <p class="mb-1">{{ activite.description }}</p>
                                            </div>
                                            <div class="text-end">
                                                <a href="{% url 'users:take_quiz' activite.id %}" class="btn btn-success btn-sm" aria-label="Commencer le quiz"><i class="bi bi-play-circle me-1"></i> Commencer</a>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% empty %}
                                    <p class="p-3 text-muted">Aucun quiz disponible.</p>
                                {% endfor %}
                            </div>

                            <!-- Sondages Section -->
                            <h6 class="mb-3 text-primary"><i class="bi bi-bar-chart-steps me-2"></i>Sondages</h6>
                            <div class="list-group">
                                {% for activite in activites %}
                                    {% if activite.activity_type == 'SONDAGE' %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="mb-1">{{ activite.title }}</h5>
                                                <small class="text-muted">Date limite : {{ activite.due_date|date:"d/m/Y H:i" }}</small>
                                                <p class="mb-1">{{ activite.description }}</p>
                                            </div>
                                            <div class="text-end">
                                                {% if activite.id in submitted_sondages_ids %}
                                                    <button class="btn btn-secondary btn-sm" disabled><i class="bi bi-check-circle me-1"></i>Déjà répondu</button>
                                                {% else %}
                                                    <a href="{% url 'users:take_sondage' activite.id %}" class="btn btn-primary btn-sm" aria-label="Participer au sondage"><i class="bi bi-check-circle me-1"></i> Participer</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                {% empty %}
                                    <p class="p-3 text-muted">Aucun sondage disponible.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forum Tab Content -->
                <div class="tab-pane fade" id="forum" role="tabpanel" aria-labelledby="forum-tab">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0">Forum</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Discutez avec vos camarades et l'enseignant.</p>
                            <a href="{% url 'forums:forum_cours' course.id %}" class="btn btn-primary" aria-label="Accéder au forum"><i class="bi bi-chat-left-text me-2"></i> Accéder au Forum</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0">Informations du Cours</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Enseignant :</strong> {{ course.teacher.first_name }} {{ course.teacher.last_name }}</p>
                    <a href="{% url 'messaging:new_conversation' course.teacher.id %}" class="btn btn-sm btn-outline-primary mb-3" aria-label="Contacter l'enseignant"><i class="bi bi-chat-dots me-1"></i> Contacter l'enseignant</a>
                    {% if course.visio_link %}
                        <p class="mb-2"><strong>Visioconférence :</strong> <a href="{{ course.visio_link }}" target="_blank" class="text-decoration-none">Rejoindre la session <i class="bi bi-box-arrow-up-right"></i></a></p>
                    {% endif %}
                    {% if course.visio_date %}
                        <p class="mb-0"><strong>Date de la Visio :</strong> {{ course.visio_date|date:"d/m/Y H:i" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('.form-check-input');
    const csrftoken = getCookie('csrftoken');

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function (e) {
            const target = e.target.closest('input[type="checkbox"]');
            if (!target) return;
            const ressourceId = target.dataset.ressourceId;
            const url = `/courses/api/ressources/${ressourceId}/complete/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Failed to mark ressource as complete');
                }
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}